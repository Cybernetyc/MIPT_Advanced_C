#include "root.h"
#include <stdio.h>
#include <math.h>

/*
 * Поиск корня уравнения f(x) = g(x) на отрезке [a, b] методом Ньютона (касательных)
 *
 * Параметры:
 *   f, g      - указатели на функции, которые сравниваем
 *   df, dg    - указатели на производные функций f и g
 *   a, b      - границы интервала поиска
 *   eps       - требуемая точность
 *   iter_count- указатель для возврата количества итераций
 *
 * Возвращает:
 *   Найденный корень или NAN, если:
 *   - не удалось достичь сходимости
 *   - производная (f' - g') близка к нулю
 *   - корень вне отрезка [a, b]
 */
double root(double (*f)(double), double (*g)(double),
            double (*df)(double), double (*dg)(double),
            double a, double b, double eps, int *iter_count) {

  double x = (a + b) / 2;  // Начальное приближение - середина отрезка
  double h, dh, delta;     // h = f(x)-g(x), dh = производная h
  int iter = 0;            // Счётчик итераций
  const int max_iter = 1000; // Защита от бесконечного цикла

  do {
    h = f(x) - g(x);     // Разность функций в текущей точке
    dh = df(x) - dg(x);  // Производная разности

    // Защита от деления на ноль
    if (fabs(dh) < 1e-12)
      return NAN;


    delta = h / dh;     // Поправка Ньютона
    x -= delta;         // Новое приближение
    iter++;

    // Выход при достижении точности или превышении итераций
  } while (fabs(delta) > eps && iter < max_iter);

  *iter_count = iter; // Возвращаем количество итераций

  // Проверка, что корень в пределах исходного отрезка
  if (x < a || x > b)
    return NAN;

  return x;
}